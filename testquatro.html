<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>2-index formulation for Capacitated Vehicle Routing Problem</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="testquatro_files/libs/clipboard/clipboard.min.js"></script>
<script src="testquatro_files/libs/quarto-html/quarto.js"></script>
<script src="testquatro_files/libs/quarto-html/popper.min.js"></script>
<script src="testquatro_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="testquatro_files/libs/quarto-html/anchor.min.js"></script>
<link href="testquatro_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="testquatro_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="testquatro_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="testquatro_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="testquatro_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">2-index formulation for Capacitated Vehicle Routing Problem</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>## 2 index Vehicle Routing Problem Formulation</p>
<p>In this tutorial we will take a look at a couple of formulations for vehicle routing problem. We will first discuss a two index vehicle flow formulation that uses $O(n^2)$ binary variables $x$ to indicate if a vehicle traverses on an arc in the optimal solution. In other words, variable $x_{ij}$ takes the value 1 if arc $(i,j) \in A$ belongs to the optimal solution and takes value 0 otherwise.</p>
<p>We designate cost of travelling on arc $(i,j)$ with $c_{ij}$. In this formulation, the vehicles share a common capacity value $C$. The demand/load at each city is designated by $d_i$. Unless otherwise stated, we will consider node $\{0\}$ to be the origin and final destination. The number of trucks are designated by $K$.</p>
<p>It stands to reason that simplest way to define the cost function is to sum the distance travelled by all the vehicles and all the arcs covered.</p>
<p>$$min \sum_{i \in V} \sum_{j \in V} c_{ij}x_{ij}$$ subject to</p>
<p>$$\sum_{i \in V} x_{ij} = 1 ,\forall j \in V \setminus \{0\}, $$ This constraint assures that except for the origin, each city must be entered exactly once.</p>
<p>$$\sum_{j \in V} x_{ij} = 1 ,\forall i \in V \setminus \{0\}, $$ This constraint assures that except for the origin , each city will be exited exactly once.</p>
<p>$$\sum_{i \in V} x_{i0} = K,$$ This constraint states that at the origin, exactly $K$ vehicles should return.</p>
<p>$$\sum_{j \in V} x_{0j} = K,$$ This constraint is required for assuring that from the origin, exactly $K$ vehicles depart.</p>
<p>In addition to these standard constraints, we need to impose subtour elimination constraints. There are multiple ways to write these constraints, but the MTZ formulation for subtour elimination is most intuitive and straight forward to implement in integer programming realm. The central concept is as follows. A new integer variable is introduced $u_i,i \in V \setminus \{0\}$. This represents the load of the vehicle after visiting customer $i$.</p>
<p>$$u_i - u_j +Cx_{ij} \le C - d_j , \forall i, j \in V \setminus \{0\}$$</p>
<p>$$d_i \le u_i \le C , \forall i \in V \setminus \{0\}$$</p>
<p>Above two constraints impose both the capacity and connectivity requirements. When $x_{ij}=0$, constraint is not binding since $u_i \le C$ and $u_j \ge d_j$. Where as when $x_{ij}=1$, they impose that $u_j \ge u_i + d_j$.</p>
<section id="ampl-implementation" class="level2">
<h2 class="anchored" data-anchor-id="ampl-implementation">AMPL Implementation</h2>
<p>Now that we have the equations written down, how shall we implement this in the AMPL? Consider following code chunk.</p>
<p>```ampl # Two index formulation : # n = number of cities param n&gt;=0; # k = number of trucks param K&gt;=0; # C = capacity of each truck - same capacity param C &gt;=0;</p>
</section>
<section id="create-the-set-for-all-the-nodes---0-indicating-the-depot" class="level1">
<h1>Create the set for all the nodes - 0 indicating the depot</h1>
<p>set N :=0..n; # Create the set of arcs set A :={i in N,j in N:i&lt;&gt;j};</p>
<p>param c{A}&gt;=0; # d = demand vector at all the cities except for the depot param d{1..n};</p>
</section>
<section id="decision-variable" class="level1">
<h1>decision variable</h1>
<p>var x{A} binary; # additional decision variable to remove subtours per MTZ formulation var u{1..n} &gt;=0;</p>
</section>
<section id="objective-function-is-sum-of-all-distances-travelled" class="level1">
<h1>Objective function is sum of all distances travelled</h1>
<p>minimize cost: sum{i in N,j in N:i&lt;&gt;j} c[i,j]*x[i,j];</p>
</section>
<section id="each-city-must-be-entered-only-once" class="level1">
<h1>Each city must be entered only once</h1>
<p>s.t. C1{j in 1..n}:sum{i in N:i&lt;&gt;j} x[i,j]=1; # Each city must be exited only once s.t. C2{i in 1..n}:sum{j in N:i&lt;&gt;j} x[i,j]=1; # From depot, exactly K trucks should depart s.t. C3:sum{j in 1..n} x[0,j]=K; # At the depot, exactly K trucks should arrive s.t. C31:sum{i in 1..n} x[i,0]=K;</p>
</section>
<section id="mtz-dictated-subtour-elimination-constraint-1" class="level1">
<h1>MTZ dictated subtour elimination constraint 1</h1>
<p>s.t. C4{i in 1..n,j in 1..n:i&lt;&gt;j}: u[i] - u[j] + C*x[i,j] &lt;= C- d[j]; # MTZ dictated subtour elimination constraint 2 s.t. C5{i in 1..n}:d[i]&lt;= u[i] &lt;= C;</p>
<p>```</p>
<p>```ampl</p>
<p>```</p>
<section id="index-open-vehicle-routing-problem-formulation" class="level2">
<h2 class="anchored" data-anchor-id="index-open-vehicle-routing-problem-formulation">2 index Open Vehicle Routing Problem Formulation</h2>
<p>```{r} library(tidyverse) library(knitr) knitr::include_graphics(here::here(‘www/‎VRP_schematics_open.png.‎001.png’)) ```</p>
<p>In case of the open formulation, we will re-adjust the problem following way. Lets define two new sets- $V := 1,…,n$ that cover only cities and $V’ := 0,1,…,n,n+1$ that covers the cities as well as start and end depot. Since the start and end depots are imaginary, we can set the cost to and from all the cities as 0. The way we make it happen is by “wrapping” the cost matrix by 0 distance elements. For instance, if the number of cities that need to be distributed between trucks are 3, then the augmented matrix would look something like this.</p>
<p>$$\left[\begin{array}{cccc} 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\ 0 &amp; c_11 &amp; c_12 &amp; c_13 &amp; 0 \\ 0 &amp; c_21 &amp; c_22 &amp; c_23 &amp; 0 \\ 0 &amp; c_31 &amp; c_32 &amp; c_33 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \end{array}\right]$$</p>
<p>With this setup,let’s write down the constraints again.</p>
<p>subject to</p>
<p>$$\sum_{i \in V’} x_{ij} = 1 ,\forall j \in V,\\</p>
<p>\sum_{j \in V’} x_{ij} = 1 ,\forall i \in V,\\</p>
<p>\sum_{i \in V’} x_{i0} = K,\\</p>
<p>\sum_{j \in V’} x_{0j} = K,\\</p>
<p>u_i - u_j +Cx_{ij} \le C - d_j , \forall i, j \in V\\</p>
<p>d_i \le u_i \le C , \forall i \in V$$</p>
<p>Note that majority of the formulation remains the same except for two additional constraints we need to pose. They are around not allowing any tours to start from the destination depot and not allowing any tours to terminate to the start depot.</p>
<p>$$ \sum_{i \in V’}x_{i,0}=0\\ \sum_{i \in V’}x_{n+1,i}=0</p>
<p>$$ With these two additional constraints, we are set.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>